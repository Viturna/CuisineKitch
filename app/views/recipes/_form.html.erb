<div class="mx-4">
  <%= form_with(model: recipe, html: { onsubmit: "return validateImageURL();" }) do |form| %>
    <% if recipe.errors.any? %>
      <div style="color: red">
        <h2><%= pluralize(recipe.errors.count, "error") %> prohibited this recipe from being saved:</h2>
        <ul>
          <% recipe.errors.each do |error| %>
            <li><%= error.full_message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
    <div class="mb-4">
      <%= form.label "Titre de la recette", style: "display: block", class: "form-label" %>
      <%= form.text_field :title, class: "form-control", placeholder: "Lasagne au chocolat" %>
    </div>
    <div class="mb-4">
      <strong>Choisir les catégories :</strong><br>
      <% Category.all.each do |category| %>
        <%= check_box_tag "recipe[category_ids][]", category.id, @recipe.categories.include?(category), id: "recipe_category_ids_#{category.id}", class: "form-check-input" %>
        <%= label_tag "recipe_category_ids_#{category.id}", category.title %><br>
      <% end %>
    </div>
    <div class="mb-4">
      <strong>Choisir les ingrédients :</strong><br>
      <div class="row row-cols-3">
        <% Ingredient.all.each do |ingredient| %>
          <div class="col">
            <div>
              <%= check_box_tag "recipe[ingredient_ids][]", ingredient.id, @recipe.ingredients.include?(ingredient), id: "recipe_ingredient_ids_#{ingredient.id}", class: "ingredient-checkbox form-check-input", data: { ingredient_id: ingredient.id } %>
              <%= label_tag "recipe_ingredient_ids_#{ingredient.id}", ingredient.title %><br>
            </div>
            <div row>
              <div class="mb-4 input-quantite">
                <% quantity = @quantities[ingredient.id] %>
                <%= text_field_tag "recipe[ingredient_quantities][#{ingredient.id}]", quantity, placeholder: 'Quantité', class: "form-control form-time ingredient-quantity", data: { ingredient_id: ingredient.id } %>
              </div>
              <div class="col">
                <% unity = @unities[ingredient.id] %>
                <%= select_tag "recipe[ingredient_unitys][#{ingredient.id}]", options_for_select(["g", "kg", "mL", "cL", "L", "pièce(s)", "tranche(s)"], unity), class: "form-control" %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    <div class ="row row-cols-3 mb-4 px-0">
      <div class="col">
        <%= form.label "Temps de préparation", style: "display: block"%>
        <%= form.time_field :preparationtime, class: "form-control form-time" %>
      </div>
      <div class="col">
        <%= form.label "Temps de cuisson", style: "display: block"%>
        <%= form.time_field :cookingtime, class: "form-control form-time"  %>
      </div>
      <div class="col">
        <%= form.label "Temps de repos", style: "display: block"%>
        <%= form.time_field :restingtime, class: "form-control form-time"  %>
      </div>
    </div>
    <div class="mb-4">
      <%= form.label "Description", style: "display: block", class: "mb-2" %>
      <%= form.text_area :description, class: "form-control", placeholder: "Description de votre recette" %>
    </div>
    <div class="row row-cols-3 mb-4 px-0">
      <div class="col">
        <%= form.label "Niveau de difficulté", style: "display: block", class: "form-label" %>
        <%= form.select :difficulty, options_for_select(["Très facile", "Facile", "Intermédiaire", "Difficile"]), { prompt: "Choisir le niveau de difficulté" }, class: "form-control" %>
      </div>
      <div class="col">
        <%= form.label "Budget", style: "display: block", class: "form-label" %>
        <%= form.select :price, options_for_select(["Bon marché", "Ultra cher"]), { prompt: "Choisir le niveau de budeget" }, class: "form-control" %>
      </div>
      <div class="col">
        <%= form.label :nbperson, "Nombre de personnes", style: "display: block", class: "form-label" %>
        <%= form.number_field :nbperson, class: "form-control" %>
      </div>
    </div>
    <!-- Boucle pour afficher les étapes -->
    <% (1..10).each do |step_number| %>
      <% step_content = recipe.send("step#{step_number}") %>
      <div class="mb-4">
        <%= form.label "Etape #{step_number}", style: "display: block", class: "mb-2" %>
        <%= form.text_area "step#{step_number}", value: step_content, class: "form-control", placeholder: "Descriptif de l'étape #{step_number}" %>
      </div>
    <% end %>
    <div class="mb-4">
      <%= form.label "URL de votre image", style: "display: block", class: "mb-2" %>
      <%= form.text_field :image, class: "form-control", placeholder: "Insérez l'URL de votre image", id: "recipe-image-url" %>
    </div>
    <div class="d-flex align-items-center justify-content-end gap-5">
    <div>
      <%= link_to "Annuler", @recipe, class: "link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" %>
    </div>
    <div class="ml-4">
      <%= form.submit "Valider", class: "btn btn-dark btn-lg" %>
    </div>
  </div>
<% end %>

<script>
  function validateImageURL() {
    var imageURL = document.getElementById('recipe-image-url').value;
    var urlRegex = /^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,5}(:[0-9]{1,5})?(\/.*)?$/;

    if (!urlRegex.test(imageURL)) {
      alert("Veuillez entrer une URL d'image valide.");
      return false; // Empêche la soumission du formulaire si l'URL n'est pas valide
    }
    return true; // Autorise la soumission du formulaire si l'URL est valide
  }
</script>